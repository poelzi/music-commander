# Work Packages: Mixxx to Git-Annex Metadata Sync

**Inputs**: Design documents from `/kitty-specs/002-mixxx-to-git/`
**Prerequisites**: plan.md, spec.md, research.md, data-model.md, quickstart.md

**Tests**: Not explicitly requested - included only where critical for validation.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package is independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Mixxx Database Queries (Priority: P0)

**Goal**: Implement SQLAlchemy queries to extract track metadata and crate membership from Mixxx database.
**Independent Test**: Query functions return correct metadata for test tracks in a sample Mixxx database.
**Prompt**: `tasks/WP01-mixxx-database-queries.md`

### Included Subtasks
- [ ] T001 Create `music_commander/db/queries.py` with track metadata query function
- [ ] T002 Add crate membership query joining `crate_tracks` and `crates` tables
- [ ] T003 Add change detection query filtering by `source_synchronized_ms`
- [ ] T004 Create `TrackMetadata` dataclass in `music_commander/db/models.py`
- [ ] T005 Add path matching logic to convert absolute Mixxx paths to relative repo paths

### Implementation Notes
- Use existing SQLAlchemy session from `music_commander/db/mixxx.py`
- Join `library` â†’ `track_locations` for file paths
- Return `TrackMetadata` dataclass instances with all mapped fields
- Handle NULL values gracefully (return None for optional fields)

### Parallel Opportunities
- T001 and T002 can be developed in parallel (different query functions)

### Dependencies
- None (first package)

### Risks & Mitigations
- Mixxx schema version differences â†’ validate against schema.xml from Mixxx repo
- Large result sets â†’ use generator/iterator pattern for memory efficiency

---

## Work Package WP02: Git-Annex Metadata Batch Wrapper (Priority: P0)

**Goal**: Create Python wrapper for `git annex metadata --batch --json` subprocess communication.
**Independent Test**: Wrapper can set/get metadata on test annexed files via batch mode.
**Prompt**: `tasks/WP02-annex-metadata-batch.md`

### Included Subtasks
- [ ] T006 Create `music_commander/utils/annex_metadata.py` with batch process manager
- [ ] T007 Implement `AnnexMetadataBatch` context manager for subprocess lifecycle
- [ ] T008 Add `set_metadata(file, fields)` method with JSON stdin/stdout handling
- [ ] T009 Add `get_metadata(file)` method for reading existing metadata
- [ ] T010 Implement commit control with `annex.alwayscommit=false` and manual merge
- [ ] T011 Add field value transformation (rating intâ†’str, color intâ†’hex, bpm floatâ†’str)

### Implementation Notes
- Start subprocess with `git -c annex.alwayscommit=false annex metadata --batch --json`
- Use line-buffered I/O for streaming responses
- Parse JSON responses and handle `success: false` cases
- Implement `__enter__`/`__exit__` for clean subprocess termination

### Parallel Opportunities
- T011 (transformations) can be developed independently from T006-T010 (subprocess)

### Dependencies
- None (can proceed in parallel with WP01)

### Risks & Mitigations
- Subprocess hangs â†’ implement timeout and graceful termination
- JSON parse errors â†’ wrap in try/except, log malformed responses

---

## Work Package WP03: Sync State Management (Priority: P0)

**Goal**: Implement sync state storage in git-annex metadata on sentinel file.
**Independent Test**: Sync timestamp can be written and read back across process restarts.
**Prompt**: `tasks/WP03-sync-state-management.md`

### Included Subtasks
- [ ] T012 Add `SyncState` dataclass with `last_sync_timestamp` and `tracks_synced` fields
- [ ] T013 Implement `read_sync_state(repo_path)` function using annex metadata
- [ ] T014 Implement `write_sync_state(repo_path, state)` function
- [ ] T015 Create `.music-commander-sync-state` sentinel file if not exists
- [ ] T016 Add ISO 8601 timestamp serialization/deserialization

### Implementation Notes
- Use batch wrapper from WP02 to read/write sentinel file metadata
- Handle first-run case (no sentinel file = sync all tracks)
- Sentinel file can be empty or contain marker text
- Store state as git-annex metadata fields: `sync-timestamp`, `tracks-synced`

### Parallel Opportunities
- None (depends on WP02 for batch wrapper)

### Dependencies
- Depends on WP02 (uses AnnexMetadataBatch)

### Risks & Mitigations
- Sentinel file accidentally deleted â†’ recreate on next sync
- Clock skew between machines â†’ use UTC timestamps exclusively

---

## Work Package WP04: Core Sync Logic (Priority: P1) ðŸŽ¯ MVP

**Goal**: Implement the main sync workflow: query Mixxx â†’ filter changes â†’ transform â†’ write to annex.
**Independent Test**: Running sync on a test repo with sample Mixxx DB updates git-annex metadata correctly.
**Prompt**: `tasks/WP04-core-sync-logic.md`

### Included Subtasks
- [ ] T017 Create `music_commander/commands/sync_metadata.py` with core sync function
- [ ] T018 Implement track filtering: changed since last sync OR all tracks
- [ ] T019 Implement path matching: filter to tracks within repo, skip others with warning
- [ ] T020 Implement metadata transformation: Mixxx fields â†’ annex fields
- [ ] T021 Implement batch write loop with progress tracking
- [ ] T022 Create `SyncResult` dataclass for tracking synced/skipped/failed
- [ ] T023 Implement summary reporting at sync completion

### Implementation Notes
- Use generator pattern: query â†’ filter â†’ transform â†’ write (streaming)
- Track counts for synced, skipped (not in repo), failed (annex error)
- Show Rich progress bar during batch write phase
- Commit all changes at end (single commit per sync)

### Parallel Opportunities
- T022 (dataclass) and T023 (reporting) can be developed in parallel

### Dependencies
- Depends on WP01 (Mixxx queries), WP02 (annex batch), WP03 (sync state)

### Risks & Mitigations
- Memory with large libraries â†’ use streaming/generator pattern
- Partial failure â†’ log per-file errors, continue, report summary

---

## Work Package WP05: CLI Command & Options (Priority: P1)

**Goal**: Create Click CLI command with all specified options (`--all`, `--dry-run`, `--batch-size`, paths).
**Independent Test**: `music-commander sync-metadata --help` shows all options; basic invocation works.
**Prompt**: `tasks/WP05-cli-command.md`

### Included Subtasks
- [ ] T024 Add `sync-metadata` command to `music_commander/commands/sync_metadata.py`
- [ ] T025 Implement `--all` / `-a` flag for full resync
- [ ] T026 Implement `--dry-run` / `-n` flag for preview mode
- [ ] T027 Implement `--batch-size` / `-b` option for commit chunking
- [ ] T028 Implement positional `PATHS` argument for filtering to specific files/directories
- [ ] T029 Register command in `music_commander/commands/__init__.py`
- [ ] T030 Add sync-specific exceptions to `music_commander/exceptions.py`

### Implementation Notes
- Follow pattern from existing `get_commit_files.py` command
- Use Click decorators: `@click.command()`, `@click.option()`, `@click.argument()`
- Validate paths exist and are under repo
- Wire to core sync function from WP04

### Parallel Opportunities
- T030 (exceptions) can be developed in parallel with CLI options

### Dependencies
- Depends on WP04 (core sync logic)

### Risks & Mitigations
- Path validation edge cases â†’ test with symlinks, relative paths, absolute paths

---

## Work Package WP06: Crate Sync & Multi-Value Fields (Priority: P2)

**Goal**: Implement crate membership sync as multi-value git-annex `crate` field.
**Independent Test**: Track in multiple crates shows all crate names in git-annex metadata.
**Prompt**: `tasks/WP06-crate-sync.md`

### Included Subtasks
- [ ] T031 Extend Mixxx query to include crate membership per track
- [ ] T032 Add crate name sanitization for git-annex compatibility
- [ ] T033 Implement multi-value field handling in annex batch wrapper
- [ ] T034 Handle crate removal: set empty array to remove old crates

### Implementation Notes
- Query joins: `library` â†’ `crate_tracks` â†’ `crates`
- Group crate names by track ID
- Sanitize: replace special chars that git-annex may not handle
- Multi-value: `{"crate": ["Crate1", "Crate2", "Crate3"]}`

### Parallel Opportunities
- T032 (sanitization) can be developed independently

### Dependencies
- Depends on WP01 (queries), WP02 (batch wrapper)

### Risks & Mitigations
- Very long crate lists â†’ no practical limit, but warn if >50 crates per track

---

## Work Package WP07: Polish & Documentation (Priority: P3)

**Goal**: Final cleanup, edge case handling, and documentation updates.
**Independent Test**: All edge cases handled gracefully; quickstart.md scenarios work end-to-end.
**Prompt**: `tasks/WP07-polish-documentation.md`

### Included Subtasks
- [ ] T035 Handle edge case: file in Mixxx but not in repo (skip with warning)
- [ ] T036 Handle edge case: special characters in metadata values
- [ ] T037 Handle edge case: very long metadata values (truncate with warning)
- [ ] T038 Validate quickstart.md scenarios work end-to-end
- [ ] T039 Update README.md with sync-metadata command documentation
- [ ] T040 Add example usage to `--help` output

### Implementation Notes
- Test with real-world Mixxx database if available
- Ensure warnings are clear and actionable
- Keep documentation concise and example-driven

### Parallel Opportunities
- T035-T037 (edge cases) can proceed in parallel
- T038-T040 (documentation) can proceed in parallel

### Dependencies
- Depends on WP05 (CLI complete)

### Risks & Mitigations
- Documentation drift â†’ keep docs close to implementation

---

## Dependency & Execution Summary

```
WP01 (Mixxx Queries) â”€â”€â”¬â”€â”€> WP04 (Core Sync) â”€â”€> WP05 (CLI) â”€â”€> WP07 (Polish)
                       â”‚                              â”‚
WP02 (Annex Batch) â”€â”€â”€â”€â”¤                              â”‚
                       â”‚                              â”‚
WP03 (Sync State) â”€â”€â”€â”€â”€â”˜                              â”‚
                                                      â”‚
WP06 (Crates) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

- **Sequence**: WP01+WP02 (parallel) â†’ WP03 â†’ WP04 â†’ WP05 â†’ WP06+WP07 (parallel)
- **Parallelization**: WP01 and WP02 can proceed in parallel; WP06 and WP07 can proceed in parallel
- **MVP Scope**: WP01 â†’ WP02 â†’ WP03 â†’ WP04 â†’ WP05 (basic sync without crates)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Track metadata query | WP01 | P0 | No |
| T002 | Crate membership query | WP01 | P0 | Yes |
| T003 | Change detection query | WP01 | P0 | No |
| T004 | TrackMetadata dataclass | WP01 | P0 | Yes |
| T005 | Path matching logic | WP01 | P0 | No |
| T006 | Annex batch process manager | WP02 | P0 | No |
| T007 | Context manager lifecycle | WP02 | P0 | No |
| T008 | set_metadata method | WP02 | P0 | No |
| T009 | get_metadata method | WP02 | P0 | Yes |
| T010 | Commit control | WP02 | P0 | No |
| T011 | Field value transformations | WP02 | P0 | Yes |
| T012 | SyncState dataclass | WP03 | P0 | No |
| T013 | read_sync_state function | WP03 | P0 | No |
| T014 | write_sync_state function | WP03 | P0 | No |
| T015 | Sentinel file creation | WP03 | P0 | No |
| T016 | Timestamp serialization | WP03 | P0 | Yes |
| T017 | Core sync function | WP04 | P1 | No |
| T018 | Track filtering | WP04 | P1 | No |
| T019 | Path matching filter | WP04 | P1 | No |
| T020 | Metadata transformation | WP04 | P1 | No |
| T021 | Batch write with progress | WP04 | P1 | No |
| T022 | SyncResult dataclass | WP04 | P1 | Yes |
| T023 | Summary reporting | WP04 | P1 | Yes |
| T024 | sync-metadata command | WP05 | P1 | No |
| T025 | --all flag | WP05 | P1 | Yes |
| T026 | --dry-run flag | WP05 | P1 | Yes |
| T027 | --batch-size option | WP05 | P1 | Yes |
| T028 | PATHS argument | WP05 | P1 | Yes |
| T029 | Command registration | WP05 | P1 | No |
| T030 | Sync exceptions | WP05 | P1 | Yes |
| T031 | Extend query for crates | WP06 | P2 | No |
| T032 | Crate name sanitization | WP06 | P2 | Yes |
| T033 | Multi-value field handling | WP06 | P2 | No |
| T034 | Crate removal handling | WP06 | P2 | No |
| T035 | Edge: file not in repo | WP07 | P3 | Yes |
| T036 | Edge: special characters | WP07 | P3 | Yes |
| T037 | Edge: long values | WP07 | P3 | Yes |
| T038 | Validate quickstart | WP07 | P3 | Yes |
| T039 | Update README | WP07 | P3 | Yes |
| T040 | Example in --help | WP07 | P3 | Yes |
