# Work Packages: Real Git-Annex Integration Test Suite

**Inputs**: Design documents from `kitty-specs/004-real-git-annex-integration-tests/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md

**Tests**: This feature IS a test suite — all work packages produce tests.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `kitty-specs/004-real-git-annex-integration-tests/tasks/` generated by `/spec-kitty.tasks`.

## Path Conventions
- **Test infrastructure**: `tests/integration/conftest.py`
- **Integration tests**: `tests/integration/test_*.py`
- **Unit tests (modified)**: `tests/unit/test_cache_builder.py`, `tests/unit/test_e2e_search_view.py`
- **Nix/project config**: `flake.nix`, `pyproject.toml`

---

## Work Package WP01: Dependencies & Audio Generation Infrastructure (Priority: P0)

**Goal**: Add ffmpeg and mutagen to the nix dev shell and pyproject.toml, and create the audio file generation utilities used by all test fixtures.
**Independent Test**: Run the audio generation helper in isolation to produce 6 audio files with tags and artwork.
**Prompt**: `kitty-specs/004-real-git-annex-integration-tests/tasks/WP01-deps-and-audio-generation.md`

### Included Subtasks
- [x] T001 Add `ffmpeg` to `flake.nix` devShell buildInputs
- [x] T002 Add `mutagen` to `flake.nix` devDeps and `pyproject.toml` dev dependencies
- [x] T003 Create `tests/integration/__init__.py`
- [x] T004 Create audio generation helper in `tests/integration/conftest.py`: WAV sine wave via `struct`+`wave`, ffmpeg conversion to mp3/flac/aiff
- [x] T005 Create tagging helper: use mutagen to write artist/title/album/genre/bpm/year/tracknumber tags and embed artwork PNG
- [x] T006 Create minimal PNG artwork generator (raw bytes, no image library)

### Implementation Notes
- WAV: 44100Hz, mono, 16-bit, ~0.5s sine wave at 440Hz
- ffmpeg commands: `ffmpeg -i input.wav -q:a 2 output.mp3`, `ffmpeg -i input.wav output.flac`, `ffmpeg -i input.wav output.aiff`
- Artwork: 8x8 solid-color PNG (~70 bytes), constructed from raw IHDR+IDAT+IEND chunks
- Mutagen: `MP3`/`FLAC`/`AIFF` classes for format-specific tagging

### Parallel Opportunities
- T001 and T002 can be done in parallel (different files)
- T004, T005, T006 are sequential (T006 feeds T005 feeds T004)

### Dependencies
- None (starting package)

### Risks & Mitigations
- ffmpeg not found in PATH: test should skip gracefully with `pytest.importorskip` or check `shutil.which("ffmpeg")`
- mutagen API differences across formats: research ID3 vs VorbisComment vs AIFF tagging in mutagen docs

---

## Work Package WP02: Git-Annex Test Fixtures (Priority: P0)

**Goal**: Create session-scoped pytest fixtures that initialize a real git-annex repo with 6 synthetic audio files and metadata, plus a partial clone with only 3 files fetched.
**Independent Test**: Fixtures create valid repos; `git annex metadata` and `git annex find` return expected data.
**Prompt**: `kitty-specs/004-real-git-annex-integration-tests/tasks/WP02-git-annex-fixtures.md`

### Included Subtasks
- [x] T007 Create `audio_files` session-scoped fixture: generates 6 audio files (2 mp3, 2 flac, 2 aiff) with distinct metadata per the plan's track table
- [x] T008 Create `origin_repo` session-scoped fixture: git init, git annex init, add files, commit, set git-annex metadata for all 6 tracks
- [x] T009 Create `partial_clone` session-scoped fixture: clone origin, `git annex get` first 3 files only
- [x] T010 Create `origin_cache_session` fixture: build cache against origin repo, yield session
- [x] T011 Create `clone_cache_session` fixture: build cache against partial clone, yield session

### Implementation Notes
- Use `tmp_path_factory` for session-scoped temp dirs
- Git annex metadata set via: `git annex metadata <file> -s artist=<val> -s title=<val> ...`
- Clone via: `git clone <origin_path> <clone_path>` then `git annex init "clone"`
- Partial get: sort files, `git annex get` first 3
- Cache sessions: call `build_cache(repo_path, session)` directly, no CLI needed

### Parallel Opportunities
- None — sequential dependency chain (audio files → origin repo → clone → cache sessions)

### Dependencies
- Depends on WP01 (audio generation infrastructure)

### Risks & Mitigations
- git-annex clone may need `git annex enableremote` or remote setup: test with `git remote` commands
- Session-scoped fixtures shared across tests: tests must not mutate repo state (use separate output dirs for views)

---

## Work Package WP03: Cache Build & Search Integration Tests (Priority: P1)

**Goal**: Write integration tests verifying cache build correctness (file paths, present field, metadata) and search behavior (returns both present and non-present tracks).
**Independent Test**: All cache and search tests pass against the real git-annex fixtures.
**Prompt**: `kitty-specs/004-real-git-annex-integration-tests/tasks/WP03-cache-and-search-tests.md`

### Included Subtasks
- [x] T012 `test_all_tracks_have_file_path`: assert every CacheTrack has `file IS NOT NULL` in partial clone cache
- [x] T013 `test_present_field_accuracy`: assert tracks 1-3 present=True, tracks 4-6 present=False
- [x] T014 `test_metadata_correctness`: assert artist/title/genre/bpm/rating match expected values for all 6 tracks
- [x] T015 `test_crate_data`: assert TrackCrate entries correct for all tracks
- [x] T016 `test_incremental_refresh_no_change`: build then refresh, assert None returned
- [x] T017 `test_fts5_search`: query FTS5 for known artist, verify result
- [x] T018 `test_search_returns_all_tracks`: search match-all, assert 6 results
- [x] T019 [P] `test_field_filter_includes_non_present`: search `rating:>=4`, assert 4 results including non-present track
- [x] T020 [P] `test_text_search`: search "DarkPulse", assert 1 result
- [x] T021 [P] `test_genre_filter`: search `genre:Ambient`, assert 2 results (both non-present)
- [x] T022 [P] `test_crate_search`: search `crate:Festival`, assert 2 results

### Implementation Notes
- Cache tests in `tests/integration/test_cache_build.py`
- Search tests in `tests/integration/test_search.py`
- Use `clone_cache_session` fixture for most tests
- Search tests use `parse_query()` + `execute_search()` directly

### Parallel Opportunities
- T019-T022 are independent search tests that can be written in parallel
- Cache tests (T012-T017) are independent of each other but share the same fixture

### Dependencies
- Depends on WP02 (fixtures)

### Risks & Mitigations
- FTS5 behavior may differ between SQLite versions: test on nix-provided SQLite

---

## Work Package WP04: View Integration Tests (Priority: P1)

**Goal**: Write integration tests for the view command, specifically verifying `--include-missing` produces more symlinks than the default when non-present files exist.
**Independent Test**: View tests pass, demonstrating the `--include-missing` flag has measurable effect.
**Prompt**: `kitty-specs/004-real-git-annex-integration-tests/tasks/WP04-view-tests.md`

### Included Subtasks
- [x] T023 `test_view_without_include_missing`: view on partial clone with `rating:>=4`, assert 3 symlinks (present only)
- [x] T024 `test_view_with_include_missing`: same query + `--include-missing`, assert 4 symlinks (strictly more)
- [x] T025 `test_symlink_targets_correct`: with `--include-missing`, verify each symlink target path is correct
- [x] T026 `test_view_full_repo_no_difference`: view on origin repo, assert same count with and without flag
- [x] T027 `test_template_rendering`: verify `{{ genre }}/{{ artist }} - {{ title }}` produces expected directory structure
- [x] T028 `test_duplicate_handling`: template producing duplicate paths, verify numeric suffix resolution

### Implementation Notes
- Tests in `tests/integration/test_view.py`
- Each test uses `tmp_path` for view output directory (not session-scoped — each test gets fresh output)
- Call `create_symlink_tree()` directly, not via CLI
- For T023/T024: use `parse_query("rating:>=4")` + `execute_search()` to get tracks, then `create_symlink_tree()`
- Key assertion: `created_with_missing > created_without_missing`

### Parallel Opportunities
- T026-T028 are independent of T023-T025

### Dependencies
- Depends on WP02 (fixtures)
- Can run in parallel with WP03

### Risks & Mitigations
- If the `--include-missing` bug is not fixed, T023/T024 will fail with equal counts — this IS the expected regression test behavior

---

## Work Package WP05: Mock Test Cleanup (Priority: P2)

**Goal**: Remove mock-heavy test classes superseded by integration tests while preserving pure-logic tests.
**Independent Test**: All remaining unit tests pass; no test coverage lost (integration tests cover removed scenarios).
**Prompt**: `kitty-specs/004-real-git-annex-integration-tests/tasks/WP05-mock-cleanup.md`

### Included Subtasks
- [ ] T029 Remove `TestBuildCache` class from `tests/unit/test_cache_builder.py` (3 methods)
- [ ] T030 Remove `TestRefreshCache` class from `tests/unit/test_cache_builder.py` (4 methods)
- [ ] T031 Remove `TestFTS5` class from `tests/unit/test_cache_builder.py` (1 method)
- [ ] T032 Remove `TestE2EPipeline` class and associated mock constants/helpers from `tests/unit/test_e2e_search_view.py`
- [ ] T033 Relocate `test_render_path_integration` and `test_delete_cache` to appropriate locations (unit tests or integration)
- [ ] T034 Run full test suite (`pytest tests/`) and verify all tests pass

### Implementation Notes
- `test_render_path_integration` is a pure logic test — move to `tests/unit/test_view_template.py`
- `test_delete_cache` is a filesystem test — move to `tests/unit/test_cache_models.py` or integration
- After removal, `test_e2e_search_view.py` may be empty — delete if so
- Keep: `TestParseMetadataLog` (14), `TestDecodeValue` (3), `TestExtractKeyFromPath` (3), `TestMetadataToTrack` (4), `TestMetadataToCrates` (2)

### Parallel Opportunities
- T029-T032 can all be done in parallel (different classes/files)

### Dependencies
- Depends on WP03 and WP04 (integration tests must exist before removing mocks)

### Risks & Mitigations
- Accidentally removing pure-logic tests: carefully verify class names before deletion
- Orphaned imports: clean up unused imports after removal

---

## Dependency & Execution Summary

- **Sequence**: WP01 → WP02 → WP03 + WP04 (parallel) → WP05
- **Parallelization**: WP03 and WP04 can run in parallel after WP02 completes
- **MVP Scope**: WP01 + WP02 + WP04 (the view tests are the primary deliverable proving the bug fix)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add ffmpeg to flake.nix | WP01 | P0 | Yes |
| T002 | Add mutagen to flake.nix + pyproject.toml | WP01 | P0 | Yes |
| T003 | Create tests/integration/__init__.py | WP01 | P0 | No |
| T004 | WAV generation + ffmpeg conversion helper | WP01 | P0 | No |
| T005 | Mutagen tagging helper | WP01 | P0 | No |
| T006 | Minimal PNG artwork generator | WP01 | P0 | No |
| T007 | audio_files session fixture | WP02 | P0 | No |
| T008 | origin_repo session fixture | WP02 | P0 | No |
| T009 | partial_clone session fixture | WP02 | P0 | No |
| T010 | origin_cache_session fixture | WP02 | P0 | No |
| T011 | clone_cache_session fixture | WP02 | P0 | No |
| T012 | test_all_tracks_have_file_path | WP03 | P1 | No |
| T013 | test_present_field_accuracy | WP03 | P1 | No |
| T014 | test_metadata_correctness | WP03 | P1 | No |
| T015 | test_crate_data | WP03 | P1 | No |
| T016 | test_incremental_refresh_no_change | WP03 | P1 | No |
| T017 | test_fts5_search | WP03 | P1 | No |
| T018 | test_search_returns_all_tracks | WP03 | P1 | No |
| T019 | test_field_filter_includes_non_present | WP03 | P1 | Yes |
| T020 | test_text_search | WP03 | P1 | Yes |
| T021 | test_genre_filter | WP03 | P1 | Yes |
| T022 | test_crate_search | WP03 | P1 | Yes |
| T023 | test_view_without_include_missing | WP04 | P1 | No |
| T024 | test_view_with_include_missing | WP04 | P1 | No |
| T025 | test_symlink_targets_correct | WP04 | P1 | No |
| T026 | test_view_full_repo_no_difference | WP04 | P1 | Yes |
| T027 | test_template_rendering | WP04 | P1 | Yes |
| T028 | test_duplicate_handling | WP04 | P1 | Yes |
| T029 | Remove TestBuildCache | WP05 | P2 | Yes |
| T030 | Remove TestRefreshCache | WP05 | P2 | Yes |
| T031 | Remove TestFTS5 | WP05 | P2 | Yes |
| T032 | Remove TestE2EPipeline + mocks | WP05 | P2 | Yes |
| T033 | Relocate test_render_path_integration + test_delete_cache | WP05 | P2 | No |
| T034 | Run full test suite verification | WP05 | P2 | No |
