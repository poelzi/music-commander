# Work Packages: Anomalistic Portal Mirror

**Inputs**: Design documents from `kitty-specs/009-anomalistic-portal-mirror/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `kitty-specs/009-anomalistic-portal-mirror/tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Foundation â€“ Shared Matching, Config, and Cache Models (Priority: P0)

**Goal**: Extract shared matching utilities, add `[anomalistic]` config section, define new cache DB models, and add `unrar-free` to Nix flake. This establishes the foundation all other WPs depend on.
**Independent Test**: Shared matching module passes existing bandcamp matcher tests (re-targeted imports). Config loads `[anomalistic]` section. Cache DB auto-creates new tables on session open.
**Prompt**: `kitty-specs/009-anomalistic-portal-mirror/tasks/WP01-foundation-matching-config-models.md`

### Included Subtasks
- [ ] T001 Extract shared matching functions from `music_commander/bandcamp/matcher.py` into `music_commander/utils/matching.py`
- [ ] T002 Update `music_commander/bandcamp/matcher.py` to import from `music_commander/utils/matching.py`
- [ ] T003 [P] Add `[anomalistic]` config fields to `music_commander/config.py` (`output_dir`, `format`, `output_pattern`, `download_source`)
- [ ] T004 [P] Define `AnomaListicRelease` and `AnomaListicTrack` models in `music_commander/cache/models.py`
- [ ] T005 Register new models in `_ALL_MODELS` in `music_commander/cache/session.py`
- [ ] T006 [P] Add `pkgs.unrar-free` to `flake.nix` `buildInputs`
- [ ] T007 Write unit tests for shared matching module (`tests/unit/test_matching.py`)
- [ ] T008 Write unit tests for anomalistic config parsing (`tests/unit/test_anomalistic_config.py`)

### Implementation Notes
- T001/T002: Move all regex patterns, normalization functions (`normalize`, `strip_punctuation`, `strip_edition_suffixes`, `normalize_for_matching`), scoring functions (`match_release`, `match_track`), and their helpers (`extract_volume`, `_roman_to_int`). Bandcamp matcher keeps its multi-phase orchestration logic.
- T003: Add dataclass fields with defaults: `anomalistic_output_dir: Path | None = None`, `anomalistic_format: str = "flac"`, `anomalistic_output_pattern: str = "{{artist}} - {{album}}"`, `anomalistic_download_source: str = "wav"`. Parse in `_parse_config_dict`, save in `save_config`.
- T004: Follow existing `BandcampRelease`/`BandcampTrack` patterns. Use `Mapped[]` type annotations, add indexes.
- T007: Can reuse/adapt existing bandcamp matcher test cases to verify extraction didn't break anything.

### Parallel Opportunities
- T003, T004, T006 can proceed in parallel once T001/T002 are done.
- T007, T008 can proceed in parallel.

### Dependencies
- None (starting package).

### Risks & Mitigations
- Matcher extraction may break existing bandcamp tests â†’ run full test suite after extraction.

---

## Work Package WP02: WordPress REST API Client (Priority: P0)

**Goal**: Build the HTTP client that fetches the full release catalog and categories from the Dark Psy Portal WordPress REST API.
**Independent Test**: Client fetches all categories and iterates all posts with pagination. Category classification returns correct genre/label/ignored types.
**Prompt**: `kitty-specs/009-anomalistic-portal-mirror/tasks/WP02-wordpress-api-client.md`

### Included Subtasks
- [x] T009 Create `music_commander/anomalistic/__init__.py` package
- [x] T010 Implement `music_commander/anomalistic/client.py` with `AnomaListicClient` class
- [x] T011 Implement category fetching and classification in `music_commander/anomalistic/category.py`
- [x] T012 Implement post pagination in `AnomaListicClient.iter_releases()`
- [x] T013 Write unit tests for client (`tests/unit/test_anomalistic_client.py`)
- [x] T014 Write unit tests for category classification (`tests/unit/test_anomalistic_category.py`)

### Implementation Notes
- T010: Simple `requests.Session` wrapper. No auth needed. Endpoints: `wp-json/wp/v2/posts?per_page=100&page=N` and `wp-json/wp/v2/categories?per_page=100`. User-Agent: `music-commander/0.1`. No rate limiter needed but sequential requests.
- T011: Hardcoded `GENRE_IDS` set (7,8,9,10,11,12,14,15,16,28,29,30,33,44,47,48,69), `IGNORED_IDS` set (1,3,6,42). Everything else = label. Return typed dataclass/NamedTuple for each category.
- T012: Pagination via `page` param, stop when page > `X-WP-TotalPages` header or empty results.
- T013/T014: Mock HTTP responses using `unittest.mock` or `responses` library.

### Parallel Opportunities
- T011 can proceed in parallel with T010 (different files).
- T013 and T014 can proceed in parallel.

### Dependencies
- Depends on WP01 (config for base URL if configurable, cache models for storing results).

### Risks & Mitigations
- Portal API may change or be rate-limited â†’ add retry logic with backoff for 429/503.

---

## Work Package WP03: HTML Content Parser (Priority: P1)

**Goal**: Parse release metadata and download URLs from WordPress REST API post content using BeautifulSoup4.
**Independent Test**: Given sample HTML content strings, parser extracts correct download URLs, tracklists, credits, and cover art URLs. Title parser correctly splits artist/album.
**Prompt**: `kitty-specs/009-anomalistic-portal-mirror/tasks/WP03-html-content-parser.md`

### Included Subtasks
- [ ] T015 Implement `music_commander/anomalistic/parser.py` with `parse_release_content()` function
- [ ] T016 Implement title parsing: `parse_title(title: str) -> tuple[str, str]` (artist, album)
- [ ] T017 Implement download URL extraction from HTML content
- [ ] T018 Implement tracklist/credits/cover art extraction from HTML content
- [ ] T019 Write unit tests for parser (`tests/unit/test_anomalistic_parser.py`)

### Implementation Notes
- T015: Main entry point takes `content.rendered` HTML string, returns a structured dataclass with download URLs, tracklist, credits, cover art URL.
- T016: Split on em-dash `\u2014`, en-dash `\u2013`, or ` - `. Handle `V/A`/`VA` prefix. HTML-decode `title.rendered` first (WordPress encodes `&amp;`, `&#8211;`, etc.).
- T017: Use BS4 to find `<a>` tags with `href` containing `anomalisticrecords.com` and file extensions `.zip`/`.rar`. Classify as WAV or MP3 based on URL content.
- T018: Extract tracklist from content (numbered lists, BPM patterns). Credits from descriptive text. Cover art from `<img>` tags.
- T019: Use real HTML samples from the portal as test fixtures.

### Parallel Opportunities
- T016, T017, T018 can proceed in parallel (different parsing concerns, same file but different functions).

### Dependencies
- Depends on WP01 (models for return types).

### Risks & Mitigations
- HTML structure varies between releases â†’ test against multiple real samples (compilations, singles, no tracklist).

---

## Work Package WP04: Download and Archive Extraction (Priority: P1)

**Goal**: Download release archives (ZIP/RAR) and extract audio files. Handle temp files, atomic renames, and both archive formats.
**Independent Test**: Given a download URL, archive is fetched, extracted (ZIP or RAR), and audio files are listed. Temp file cleanup on failure.
**Prompt**: `kitty-specs/009-anomalistic-portal-mirror/tasks/WP04-download-and-extraction.md`

### Included Subtasks
- [ ] T020 Implement archive download with temp file pattern in `music_commander/anomalistic/downloader.py`
- [ ] T021 Implement ZIP extraction
- [ ] T022 Implement RAR extraction via `unrar` subprocess
- [ ] T023 Implement archive format detection (ZIP vs RAR by file magic/extension)
- [ ] T024 Implement audio file discovery in extracted directory (filter by extension: `.wav`, `.mp3`, `.flac`, `.aif`, `.aiff`)
- [ ] T024a [P] Implement artwork file discovery in extracted directory (`.jpg`, `.png`) and copy to output folder
- [ ] T025 Write unit tests for downloader (`tests/unit/test_anomalistic_downloader.py`)

### Implementation Notes
- T020: Follow bandcamp downloader temp file pattern (`.filename.tmp` â†’ atomic rename). Stream with `chunk_size=8192`. Progress callback for Rich integration.
- T021: Python `zipfile` stdlib. Extract to temp dir, move to final location.
- T022: `subprocess.run(["unrar", "x", "-o+", archive_path, output_dir + "/"])`. Check return code. Raise clear error if `unrar` not found (`FileNotFoundError`).
- T023: Check file extension first (`.zip`, `.rar`). Fallback to `zipfile.is_zipfile()` for ambiguous cases.
- T024: Walk extracted directory, collect files matching audio extensions. Ignore `.jpg`, `.png`, `.nfo`, `.txt` etc.
- T025: Mock HTTP for download tests. Use real small ZIP/RAR fixtures for extraction tests.

### Parallel Opportunities
- T021 and T022 can proceed in parallel (different extraction backends).
- T023, T024 are small and can follow quickly.

### Dependencies
- Depends on WP02 (client provides download URLs).

### Risks & Mitigations
- `unrar` not in PATH â†’ detect at startup, warn user with installation guidance.
- Corrupt archives â†’ catch extraction errors, mark release as failed, continue with next.

---

## Work Package WP05: Conversion Pipeline and Comment Tagging (Priority: P1)

**Goal**: Convert extracted audio files to the configured target format and embed the release URL as a comment tag. Integrate with existing encoder.
**Independent Test**: Given extracted WAV files and a release URL, files are converted to FLAC (or configured format) with the URL in the comment tag.
**Prompt**: `kitty-specs/009-anomalistic-portal-mirror/tasks/WP05-conversion-and-tagging.md`

### Included Subtasks
- [ ] T026 Extend `build_ffmpeg_command()` in `music_commander/utils/encoder.py` to accept optional `extra_metadata: dict[str, str] | None`
- [ ] T026a [P] Download cover art image from portal URL and save to release output folder (fallback when archive has no artwork)
- [ ] T026b Embed cover art into converted audio files during encoding (archive artwork takes priority, then downloaded cover art)
- [ ] T027 Implement conversion orchestration in `music_commander/anomalistic/converter.py`
- [ ] T028 Implement folder pattern rendering via Jinja2 in converter
- [ ] T029 Implement `meta.json` generation per release
- [ ] T030 Handle edge case: download format matches target format (still add comment tag)
- [ ] T031 Handle edge case: MP3 download when FLAC requested (keep as MP3 with warning)
- [ ] T032 Write unit tests for conversion orchestration (`tests/unit/test_anomalistic_converter.py`)

### Implementation Notes
- T026: Add `extra_metadata` param to `build_ffmpeg_command()`. Insert `-metadata key=value` flags after `-map_metadata 0`. Ensure this doesn't break existing callers (default `None`).
- T027: For each audio file in extracted dir: probe format, select preset from config, call `build_ffmpeg_command()` with `extra_metadata={"comment": release_url}`, run ffmpeg, move to pattern-rendered output path.
- T028: `jinja2.Environment(undefined=StrictUndefined)`. Render `output_pattern` with `genre`, `label`, `artist`, `album`, `year`. Sanitize output path (remove `<>:"|?*`, strip dots/spaces from ends).
- T029: Write `meta.json` with all fields from data-model.md schema. Use `json.dump()` with `indent=2, ensure_ascii=False`.
- T030: If source codec matches target preset, still run ffmpeg to add comment metadata.
- T031: If only MP3 available and target is lossless, skip conversion, just add comment tag to MP3. Log warning.

### Parallel Opportunities
- T028 and T029 can proceed in parallel with T026/T027.

### Dependencies
- Depends on WP01 (config for format/pattern), WP04 (extracted audio files).

### Risks & Mitigations
- ffmpeg errors on specific files â†’ catch per-file, log error, continue with next file.
- Jinja2 template syntax errors â†’ validate pattern at config load time.

---

## Work Package WP06: Duplicate Detection (Priority: P2)

**Goal**: Before downloading, check if a release already exists via cache URL lookup and fuzzy artist+album matching against the local collection.
**Independent Test**: A previously-downloaded release is detected and skipped. A release matching an existing bandcamp-sourced album is flagged as duplicate.
**Prompt**: `kitty-specs/009-anomalistic-portal-mirror/tasks/WP06-duplicate-detection.md`

### Included Subtasks
- [ ] T033 Implement URL-based cache lookup (check `AnomaListicRelease` table for existing `release_url`)
- [ ] T034 Implement comment-field scan (check `CacheTrack.comment` for release URL substring)
- [ ] T035 Implement fuzzy artist+album matching against `CacheTrack` using shared `match_release()` from `utils/matching.py`
- [ ] T036 Implement duplicate decision logic (combine all signals, decide skip/download)
- [ ] T037 Implement `--force` flag to bypass all duplicate checks
- [ ] T038 Write unit tests for duplicate detection (`tests/unit/test_anomalistic_dedup.py`)

### Implementation Notes
- T033: Simple SQLAlchemy query on `anomalistic_releases` where `release_url` matches and `download_status` = "downloaded".
- T034: Query `CacheTrack` where `comment LIKE %release_url%`. If found, release already exists from this source.
- T035: Load distinct artist+album pairs from `CacheTrack`. Score each against the portal release using `match_release()`. Threshold from config (reuse `bandcamp_match_threshold` or add `anomalistic_match_threshold`).
- T036: If any check matches â†’ skip with message. Priority: URL cache > comment scan > fuzzy match.
- T037: When `--force` is passed, skip all dedup checks entirely.

### Parallel Opportunities
- T033, T034, T035 implement independent detection strategies and can proceed in parallel.

### Dependencies
- Depends on WP01 (shared matching, cache models), WP02 (release data to check against).

### Risks & Mitigations
- False positive fuzzy matches â†’ use conservative threshold; log match score for debugging.

---

## Work Package WP07: CLI Command and Integration (Priority: P1) ðŸŽ¯ MVP

**Goal**: Wire everything together into the `mirror anomalistic` CLI command. Register the `mirror` group, implement the main orchestration flow, and add progress display.
**Independent Test**: Running `music-commander mirror anomalistic` fetches the catalog, downloads, converts, and organizes releases with progress display and summary output.
**Prompt**: `kitty-specs/009-anomalistic-portal-mirror/tasks/WP07-cli-command-integration.md`

### Included Subtasks
- [ ] T039 Create `music_commander/commands/mirror/__init__.py` with `mirror` Click group
- [ ] T040 Implement `music_commander/commands/mirror/anomalistic.py` with `anomalistic` Click command
- [ ] T041 Implement main orchestration flow: fetch catalog â†’ dedup check â†’ download â†’ extract â†’ convert â†’ organize â†’ meta.json
- [ ] T042 Add Rich progress display for catalog fetch, download, and conversion phases
- [ ] T043 Add summary output (downloaded/skipped/failed counts)
- [ ] T044 Add `--force` CLI flag
- [ ] T045 Add `-v`/`--verbose` integration for detailed output
- [ ] T046 Write unit/integration tests for CLI command (`tests/unit/test_mirror_command.py`)

### Implementation Notes
- T039: Follow `commands/bandcamp/__init__.py` pattern. Define exit codes: `EXIT_SUCCESS`, `EXIT_MIRROR_ERROR`.
- T040: Use `@cli.command("anomalistic")` with `@pass_context`. Load config, validate output_dir exists or create it.
- T041: Orchestration sequence:
  1. Fetch categories â†’ classify
  2. Fetch all releases (paginated)
  3. For each release: parse title, parse content, check dedup, download archive, extract, convert with comment tag, render folder pattern, write meta.json, update cache
- T042: Use existing `MultilineFileProgress` or similar Rich progress patterns.
- T043: Print summary table with Rich: total releases, downloaded, skipped (cached), skipped (duplicate), failed.

### Parallel Opportunities
- None within orchestration (sequential by design).

### Dependencies
- Depends on WP01-WP06 (all foundation and feature packages).

### Risks & Mitigations
- Long-running operation â†’ handle KeyboardInterrupt gracefully, save progress to cache.
- Partial failures â†’ continue with next release, report failures in summary.

---

## Dependency & Execution Summary

- **Sequence**: WP01 â†’ WP02 â†’ WP03/WP04 (parallel) â†’ WP05 â†’ WP06 â†’ WP07
- **Parallelization**: WP03 and WP04 can proceed in parallel after WP02. WP05 and WP06 can partially overlap.
- **MVP Scope**: WP01 + WP02 + WP03 + WP04 + WP05 + WP07 constitute the minimal release (duplicate detection in WP06 is P2 enhancement).

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Extract shared matching to utils/matching.py | WP01 | P0 | No |
| T002 | Update bandcamp matcher imports | WP01 | P0 | No |
| T003 | Add [anomalistic] config section | WP01 | P0 | Yes |
| T004 | Define AnomaListicRelease/Track models | WP01 | P0 | Yes |
| T005 | Register models in _ALL_MODELS | WP01 | P0 | No |
| T006 | Add unrar-free to flake.nix | WP01 | P0 | Yes |
| T007 | Unit tests for shared matching | WP01 | P0 | Yes |
| T008 | Unit tests for anomalistic config | WP01 | P0 | Yes |
| T009 | Create anomalistic package | WP02 | P0 | No |
| T010 | Implement AnomaListicClient | WP02 | P0 | No |
| T011 | Implement category classification | WP02 | P0 | Yes |
| T012 | Implement post pagination | WP02 | P0 | No |
| T013 | Unit tests for client | WP02 | P0 | Yes |
| T014 | Unit tests for category classification | WP02 | P0 | Yes |
| T015 | Implement parse_release_content() | WP03 | P1 | No |
| T016 | Implement title parsing | WP03 | P1 | Yes |
| T017 | Implement download URL extraction | WP03 | P1 | Yes |
| T018 | Implement tracklist/credits extraction | WP03 | P1 | Yes |
| T019 | Unit tests for parser | WP03 | P1 | No |
| T020 | Implement archive download | WP04 | P1 | No |
| T021 | Implement ZIP extraction | WP04 | P1 | Yes |
| T022 | Implement RAR extraction via unrar | WP04 | P1 | Yes |
| T023 | Implement archive format detection | WP04 | P1 | No |
| T024 | Implement audio file discovery | WP04 | P1 | No |
| T024a | Discover and preserve artwork files from archive | WP04 | P1 | Yes |
| T025 | Unit tests for downloader | WP04 | P1 | No |
| T026 | Extend build_ffmpeg_command() with extra_metadata | WP05 | P1 | No |
| T026a | Download cover art from portal URL | WP05 | P1 | Yes |
| T026b | Embed cover art into converted audio files | WP05 | P1 | No |
| T027 | Implement conversion orchestration | WP05 | P1 | No |
| T028 | Implement folder pattern rendering | WP05 | P1 | Yes |
| T029 | Implement meta.json generation | WP05 | P1 | Yes |
| T030 | Handle format-match edge case | WP05 | P1 | No |
| T031 | Handle lossy-when-lossless-requested edge case | WP05 | P1 | No |
| T032 | Unit tests for conversion | WP05 | P1 | No |
| T033 | URL-based cache lookup | WP06 | P2 | Yes |
| T034 | Comment-field scan | WP06 | P2 | Yes |
| T035 | Fuzzy artist+album matching | WP06 | P2 | Yes |
| T036 | Duplicate decision logic | WP06 | P2 | No |
| T037 | --force flag bypass | WP06 | P2 | No |
| T038 | Unit tests for dedup | WP06 | P2 | No |
| T039 | Create mirror command group | WP07 | P1 | No |
| T040 | Implement anomalistic CLI command | WP07 | P1 | No |
| T041 | Main orchestration flow | WP07 | P1 | No |
| T042 | Rich progress display | WP07 | P1 | No |
| T043 | Summary output | WP07 | P1 | No |
| T044 | --force CLI flag | WP07 | P1 | No |
| T045 | Verbose output integration | WP07 | P1 | No |
| T046 | CLI command tests | WP07 | P1 | No |
