# Work Packages: Core Framework with Mixxx DB and git-annex

**Inputs**: Design documents from `/kitty-specs/001-core-framework-with/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, contracts/, quickstart.md

**Tests**: Included as constitution requires 80%+ coverage for core modules.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

## Path Conventions
- **Package**: `music_commander/`
- **Tests**: `tests/`
- **Config**: `flake.nix`, `pyproject.toml`

---

## Work Package WP01: Nix Flake & Project Setup (Priority: P0)

**Goal**: Establish reproducible build environment and Python package skeleton.
**Independent Test**: `nix develop` enters shell with Python 3.13 and all dependencies; `nix build` succeeds.
**Prompt**: `tasks/WP01-nix-flake-project-setup.md`

### Included Subtasks
- [X] T001 Create flake.nix with Python 3.13, Click, Rich, SQLAlchemy, tomli-w, pytest, ruff, mypy
- [X] T002 Create pyproject.toml with package metadata and entry point
- [X] T003 Create music_commander/__init__.py with __version__
- [X] T004 Create music_commander/__main__.py entry point

### Implementation Notes
- flake.nix must provide: packages.default (buildPythonApplication), devShells.default, checks.default
- Entry point: `music-commander = "music_commander.cli:cli"`
- Ensure `nix flake check` runs pytest

### Parallel Opportunities
- T003 and T004 can be done together after T001/T002

### Dependencies
- None (starting package)

### Risks & Mitigations
- Nix Python packaging complexity → use python313.pkgs.buildPythonApplication pattern

---

## Work Package WP02: Configuration & Exceptions (Priority: P0)

**Goal**: Implement configuration loading from TOML and exception hierarchy.
**Independent Test**: Config loads from ~/.config/music-commander/config.toml; missing file returns defaults.
**Prompt**: `tasks/WP02-config-and-exceptions.md`

### Included Subtasks
- [X] T005 Create music_commander/exceptions.py with exception hierarchy
- [X] T006 Create music_commander/config.py with TOML loading, defaults, validation

### Implementation Notes
- Use tomllib (stdlib) for reading, tomli-w for writing
- Config class with: mixxx_db, music_repo, colored_output, default_remote
- XDG Base Directory: ~/.config/music-commander/config.toml
- Validate paths exist, report clear errors

### Parallel Opportunities
- T005 and T006 can proceed in parallel

### Dependencies
- Depends on WP01 (package structure exists)

### Risks & Mitigations
- Path expansion edge cases → use Path.expanduser() and resolve()

---

## Work Package WP03: Database ORM Layer (Priority: P1)

**Goal**: Implement SQLAlchemy ORM models for Mixxx database with session management.
**Independent Test**: Can connect to real Mixxx DB, query tracks, create session without errors.
**Prompt**: `tasks/WP03-database-orm-layer.md`

### Included Subtasks
- [X] T007 [P] Create music_commander/db/__init__.py with exports
- [X] T008 [P] Create music_commander/db/models.py with all ORM models (Track, TrackLocation, Playlist, PlaylistTrack, Crate, CrateTrack, Cue)
- [X] T009 [P] Create music_commander/db/session.py with get_session(), WAL mode handling
- [X] T010 [P] Create music_commander/db/queries.py with read operations (query_tracks, list_playlists, list_crates, etc.)
- [X] T010a [P] Add write operations to music_commander/db/queries.py (update_track, add/remove playlist tracks, manage crate membership)

### Implementation Notes
- Use SQLAlchemy 2.0 declarative style with type hints
- Handle concurrent Mixxx access: timeout=30, WAL awareness
- Schema validation on connect (check table existence)
- Read operations: query_tracks, get_track_by_id, list_playlists, get_playlist_tracks, list_crates, get_crate_tracks
- Write operations: update_track, create_playlist, add_track_to_playlist, remove_track_from_playlist, add_track_to_crate, remove_track_from_crate
- See data-model.md for entity definitions
- See contracts/database-api.md for function signatures

### Parallel Opportunities
- All subtasks can proceed in parallel after db/__init__.py created

### Dependencies
- Depends on WP02 (exceptions.py needed for DatabaseError, etc.)

### Risks & Mitigations
- Mixxx schema version changes → validate on connect, warn on unknown columns

---

## Work Package WP04: CLI Framework & Output (Priority: P1)

**Goal**: Implement Click-based CLI with auto-discovery and Rich output helpers.
**Independent Test**: `music-commander --help` shows global options; `music-commander --version` works.
**Prompt**: `tasks/WP04-cli-framework-output.md`

### Included Subtasks
- [X] T011 [P] Create music_commander/cli.py with Click group, global options (--config, --no-color, --verbose, --quiet)
- [X] T012 [P] Create music_commander/commands/__init__.py with command auto-discovery
- [X] T013 [P] Create music_commander/utils/__init__.py
- [X] T014 [P] Create music_commander/utils/output.py with Rich console, error/success/info helpers, progress bar wrapper

### Implementation Notes
- Click group with @click.pass_context for shared state
- Auto-discovery: scan commands/ for modules with 'cli' attribute
- Rich console with force_terminal based on --no-color flag
- Error output to stderr with "Error: " prefix and "Hint: " suggestions

### Parallel Opportunities
- All subtasks can proceed in parallel

### Dependencies
- Depends on WP02 (config.py for loading settings)

### Risks & Mitigations
- Click/Rich integration → use rich.console.Console, not click.echo for styled output

---

## Work Package WP05: Git Utilities (Priority: P1)

**Goal**: Implement git revision parsing, annexed file detection, and git-annex get wrapper.
**Independent Test**: Can parse HEAD~3..HEAD, detect annexed files, execute git annex get with progress.
**Prompt**: `tasks/WP05-git-utilities.md`

### Included Subtasks
- [X] T015 [P] Create music_commander/utils/git.py with get_files_from_revision()
- [X] T016 [P] Implement is_annexed() file detection in utils/git.py
- [X] T017 [P] Implement annex_get_files() with Rich progress in utils/git.py

### Implementation Notes
- Use subprocess for git commands
- get_files_from_revision(rev): handle commit, range (A..B), branch (unique commits), tag
- For branches: `git log --name-only --pretty=format: <branch> --not HEAD`
- is_annexed(): check if symlink pointing to .git/annex/objects
- annex_get_files(): parse git-annex stderr for progress, use Rich progress bar

### Parallel Opportunities
- All subtasks can proceed in parallel

### Dependencies
- Depends on WP04 (utils/output.py for progress bars)

### Risks & Mitigations
- git-annex not installed → detect and raise clear error with install hint

---

## Work Package WP06: get-commit-files Command (Priority: P1) MVP

**Goal**: Implement the primary user-facing command to fetch annexed files from git revisions.
**Independent Test**: `music-commander get-commit-files HEAD~1` fetches files; --dry-run shows without fetching.
**Prompt**: `tasks/WP06-get-commit-files-command.md`

### Included Subtasks
- [X] T018 Create music_commander/commands/get_commit_files.py with full implementation

### Implementation Notes
- Accept REVISION argument (required)
- Options: --dry-run, --remote, --jobs
- Flow: parse revision → get files → filter annexed → fetch with progress → summarize
- Exit codes: 0 success, 1 partial failure, 2 invalid revision, 3 not git-annex repo
- Summary: fetched count/size, already present, failed with reasons
- See contracts/cli-interface.md for full specification

### Parallel Opportunities
- None (single file, depends on all prior WPs)

### Dependencies
- Depends on WP03 (not directly, but full framework needed)
- Depends on WP04 (CLI framework)
- Depends on WP05 (git utilities)

### Risks & Mitigations
- Large file counts → batch git-annex get calls, show progress

---

## Work Package WP07: Test Suite & Fixtures (Priority: P2)

**Goal**: Implement test infrastructure and achieve 80%+ coverage on core modules.
**Independent Test**: `nix flake check` passes; coverage report shows 80%+ on music_commander/.
**Prompt**: `tasks/WP07-test-suite-fixtures.md`

### Included Subtasks
- [X] T019 Create tests/conftest.py with shared fixtures
- [X] T020 Create tests/fixtures/mixxxdb_sample.sqlite with sample data
- [X] T021 Create tests/unit/test_config.py
- [X] T022 [P] Create tests/unit/test_models.py
- [X] T023 [P] Create tests/unit/test_git_utils.py
- [X] T024 Create tests/integration/test_get_commit_files.py

### Implementation Notes
- conftest.py: temp directory fixture, mock Mixxx DB, mock git-annex repo
- Sample SQLite: 10-20 tracks, 2 playlists, 2 crates, some cue points
- Unit tests: mock external calls (subprocess, file system)
- Integration: use Click's CliRunner, temp git-annex repo
- Target 80% coverage for: config.py, models.py, queries.py, git.py

### Parallel Opportunities
- T022 and T023 can proceed in parallel after T019/T020

### Dependencies
- Depends on WP06 (all code must exist to test)

### Risks & Mitigations
- Flaky git-annex tests → use deterministic temp repos, mock remotes

---

## Work Package WP08: Documentation & Polish (Priority: P2)

**Goal**: Complete documentation and ensure smooth user experience.
**Independent Test**: README provides working quickstart; --help is comprehensive.
**Prompt**: `tasks/WP08-documentation-polish.md`

### Included Subtasks
- [X] T025 Create README.md with installation, configuration, usage examples
- [X] T026 Review and refine all --help text for clarity
- [X] T027 Validate quickstart.md scenarios work end-to-end
- [X] T028 Add .gitignore for Python/Nix artifacts

### Implementation Notes
- README: badges, installation via nix, config file example, command examples
- Help text: consistent style, examples in docstrings
- Validate: run through quickstart.md steps manually

### Parallel Opportunities
- T025, T026, T27, T028 can all proceed in parallel

### Dependencies
- Depends on WP07 (tests passing confirms stability)

### Risks & Mitigations
- Documentation drift → include doc validation in CI

---

## Dependency & Execution Summary

```
WP01 (Nix/Setup)
    │
    └──► WP02 (Config/Exceptions)
              │
              ├──► WP03 (Database) ──────┐
              │                          │
              └──► WP04 (CLI) ───────────┤
                       │                 │
                       └──► WP05 (Git) ──┤
                                         │
                                         ▼
                                    WP06 (get-commit-files) MVP
                                         │
                                         ▼
                                    WP07 (Tests)
                                         │
                                         ▼
                                    WP08 (Docs/Polish)
```

- **Sequence**: WP01 → WP02 → {WP03, WP04} parallel → WP05 → WP06 → WP07 → WP08
- **Parallelization**: WP03 and WP04 can run in parallel after WP02; WP05 depends on WP04
- **MVP Scope**: WP01 through WP06 constitute minimal viable product

---

## Subtask Index (Reference)

| Subtask | Summary | WP | Priority | Parallel |
|---------|---------|-----|----------|----------|
| T001 | Create flake.nix | WP01 | P0 | No |
| T002 | Create pyproject.toml | WP01 | P0 | No |
| T003 | Create __init__.py | WP01 | P0 | Yes |
| T004 | Create __main__.py | WP01 | P0 | Yes |
| T005 | Create exceptions.py | WP02 | P0 | Yes |
| T006 | Create config.py | WP02 | P0 | Yes |
| T007 | Create db/__init__.py | WP03 | P1 | Yes |
| T008 | Create db/models.py | WP03 | P1 | Yes |
| T009 | Create db/session.py | WP03 | P1 | Yes |
| T010 | Create db/queries.py (read ops) | WP03 | P1 | Yes |
| T010a | Add db/queries.py write ops | WP03 | P1 | Yes |
| T011 | Create cli.py | WP04 | P1 | Yes |
| T012 | Create commands/__init__.py | WP04 | P1 | Yes |
| T013 | Create utils/__init__.py | WP04 | P1 | Yes |
| T014 | Create utils/output.py | WP04 | P1 | Yes |
| T015 | Create utils/git.py revision parsing | WP05 | P1 | Yes |
| T016 | Implement annexed detection | WP05 | P1 | Yes |
| T017 | Implement annex_get with progress | WP05 | P1 | Yes |
| T018 | Create get_commit_files.py | WP06 | P1 | No |
| T019 | Create conftest.py | WP07 | P2 | No |
| T020 | Create sample SQLite fixture | WP07 | P2 | No |
| T021 | Create test_config.py | WP07 | P2 | No |
| T022 | Create test_models.py | WP07 | P2 | Yes |
| T023 | Create test_git_utils.py | WP07 | P2 | Yes |
| T024 | Create test_get_commit_files.py | WP07 | P2 | No |
| T025 | Create README.md | WP08 | P2 | Yes |
| T026 | Refine --help text | WP08 | P2 | Yes |
| T027 | Validate quickstart scenarios | WP08 | P2 | Yes |
| T028 | Create .gitignore | WP08 | P2 | Yes |
