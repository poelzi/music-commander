# Work Packages: CUE Sheet Splitter

**Inputs**: Design documents from `kitty-specs/008-cue-sheet-splitter/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md, quickstart.md

**Tests**: Include tests per CLAUDE.md requirement ("Every code change must include tests").

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `kitty-specs/008-cue-sheet-splitter/tasks/` generated by `/spec-kitty.tasks`.

## Subtask Format: `[Txxx] [P?] Description`
- **[P]** indicates the subtask can proceed in parallel (different files/components).
- Include precise file paths or modules.

---

## Work Package WP01: Nix Dependencies & CUE Parser (Priority: P0)

**Goal**: Add shntool to nix flake and implement the standalone CueParser module ported from the existing script with bug fixes.
**Independent Test**: CueParser unit tests pass, parsing real-world cue sheet formats correctly.
**Prompt**: `kitty-specs/008-cue-sheet-splitter/tasks/WP01-nix-deps-and-cue-parser.md`

### Included Subtasks
- [x] T001 Add shntool to nix flake dependencies in `flake.nix`
- [x] T002 Create `music_commander/cue/__init__.py` package
- [x] T003 Implement `music_commander/cue/parser.py` â€” port CueParser from `/space/Music/bin/split-albums` with bug fixes: TRACKNUMBER tag, encoding fallback (UTF-8 â†’ Latin-1), proper error handling, multi-FILE support
- [x] T004 [P] Write unit tests in `tests/unit/test_cue_parser.py` â€” test global metadata, per-track metadata, track-level overrides, encoding fallback, multi-FILE cue sheets, edge cases (pregap, missing files)

### Implementation Notes
- The CueParser class is ported from the existing script at `/space/Music/bin/split-albums`
- Key bug fixes: `TRACK_NUM` â†’ `TRACKNUMBER` tag mapping (was `TRACKNU02MBER`), encoding fallback chain, filesystem-safe filename generation
- Parser should return dataclass instances (`CueSheet`, `CueTrack`) not raw dicts
- The `_timestr_to_samples` method is correct (44100Hz, 75 frames/sec) â€” preserve it

### Parallel Opportunities
- T004 (tests) can be written in parallel with T003 (implementation) if the interface is agreed upon first.

### Dependencies
- None (starting package).

### Risks & Mitigations
- shntool package name may differ across nixpkgs versions â†’ verify with `nix search nixpkgs shntool`.
- Cue sheet encoding edge cases â†’ comprehensive test fixtures needed.

---

## Work Package WP02: Split Engine (Priority: P0)

**Goal**: Implement the core splitting, tagging, and cover art embedding logic in `music_commander/cue/splitter.py`.
**Independent Test**: Given a cue + FLAC file pair, the splitter produces individually tagged FLAC tracks with cover art embedded.
**Prompt**: `kitty-specs/008-cue-sheet-splitter/tasks/WP02-split-engine.md`

### Included Subtasks
- [x] T005 Implement `music_commander/cue/splitter.py` â€” shntool-based splitting with ffmpeg fallback for APE/WV
- [x] T006 Implement filename sanitization helper in `music_commander/cue/splitter.py`
- [x] T007 Implement metaflac tagging logic â€” map CueTrack fields to FLAC tags, add ReplayGain
- [x] T008 Implement cover art discovery and embedding â€” single image as front cover, multi-image with front/back matching
- [x] T009 Implement skip-existing logic (check for output files) and `--force` override
- [x] T010 [P] Write unit tests in `tests/unit/test_cue_splitter.py` â€” test filename sanitization, tag mapping, cover art matching, skip logic

### Implementation Notes
- shntool command: `shntool split -t '%n - %t' -o flac -f <cue> -O never <source>`
- For APE/WV: if shntool fails, fall back to ffmpeg using timestamps from the parsed cue sheet
- Tag mapping: PERFORMERâ†’ARTIST, global TITLEâ†’ALBUM, track TITLEâ†’TITLE, TRACK_NUMâ†’TRACKNUMBER, GENRE, DATE, SONGWRITER, ISRC, DISCID
- Cover art: use `metaflac --import-picture-from=<type>||||<file>` for typed embedding
- ReplayGain: `metaflac --add-replay-gain <files>`

### Parallel Opportunities
- T010 (tests) can proceed alongside implementation if interfaces are stable.
- T006 (sanitization) and T008 (cover art) are independent of each other.

### Dependencies
- Depends on WP01 (CueParser must exist).

### Risks & Mitigations
- shntool may not support APE/WV without helper programs â†’ ffmpeg fallback handles this.
- metaflac ReplayGain requires all album tracks to exist â†’ run after all tracks are split.

---

## Work Package WP03: CLI Command Group & Split Command (Priority: P1) ðŸŽ¯ MVP

**Goal**: Create the `cue` command group and `split` subcommand, wiring up the parser and splitter into a complete CLI experience.
**Independent Test**: `music-cmd cue split /path/to/dir` splits a cue+flac pair into tagged tracks with cover art.
**Prompt**: `kitty-specs/008-cue-sheet-splitter/tasks/WP03-cli-command-group.md`

### Included Subtasks
- [x] T011 Create `music_commander/commands/cue/__init__.py` â€” Click group with `cli` attribute
- [x] T012 Implement `music_commander/commands/cue/split.py` â€” split subcommand with options: `--recursive`, `--remove-originals`, `--force`, `--dry-run`, `--encoding`, `--verbose`
- [x] T013 Implement directory scanning logic â€” find cue+audio pairs in a directory (or tree with `--recursive`)
- [x] T014 Implement `--remove-originals` post-split cleanup
- [x] T015 Implement `--dry-run` preview mode
- [x] T016 Wire up Rich output â€” progress reporting using `info()`, `verbose()`, `error()`, `success()`
- [x] T017 [P] Write CLI integration tests â€” test command registration, option parsing, dry-run output, recursive walk

### Implementation Notes
- Follow the pattern from `music_commander/commands/files/__init__.py` for group setup
- Directory scanning: for each dir, find `.cue` files, match to audio files referenced in the cue (FILE command), process each pair
- Exit codes: define `EXIT_SUCCESS`, `EXIT_SPLIT_ERROR`, `EXIT_MISSING_DEPS`
- Check for shntool/metaflac availability at command start

### Parallel Opportunities
- T017 (tests) can proceed alongside T012-T016.

### Dependencies
- Depends on WP01 (parser) and WP02 (splitter).

### Risks & Mitigations
- Command auto-discovery requires `cli` attribute in `__init__.py` â€” follow established pattern exactly.
- Recursive walks on large collections may produce lots of output â†’ use `verbose()` for per-file details.

---

## Work Package WP04: Multi-Format Support & Edge Cases (Priority: P2)

**Goal**: Ensure WAV, APE, and WavPack source formats work, handle encoding edge cases, and multi-FILE cue sheets.
**Independent Test**: Cue sheets referencing APE/WV/WAV files produce correct FLAC output; non-UTF-8 cue files parse correctly with `--encoding`.
**Prompt**: `kitty-specs/008-cue-sheet-splitter/tasks/WP04-multi-format-and-edge-cases.md`

### Included Subtasks
- [ ] T018 Implement ffmpeg fallback splitting path in `music_commander/cue/splitter.py` â€” decode APE/WV via ffmpeg, split at cue timestamps
- [ ] T019 Implement encoding fallback chain in parser â€” UTF-8 â†’ Latin-1 â†’ error with suggestion
- [ ] T020 Implement `--encoding` flag handling â€” pass user-specified encoding to parser
- [ ] T021 Handle multi-FILE cue sheets â€” iterate FILE blocks, split each referenced source
- [ ] T022 Handle edge cases: pregap (INDEX 00), hidden tracks, short source files, missing source files
- [ ] T023 [P] Write tests for multi-format splitting, encoding handling, and edge cases

### Implementation Notes
- ffmpeg fallback: use `ffmpeg -i <source> -ss <start> -to <end> -c:a flac <output>` for each track
- For last track (no end time): omit `-to` flag
- Convert cue sample positions to seconds for ffmpeg timestamps: `samples / 44100`
- Multi-FILE: the parser already handles multiple FILE commands; splitter needs to process each file independently

### Parallel Opportunities
- T018 (ffmpeg fallback) and T019 (encoding) are independent.
- T023 (tests) can proceed alongside.

### Dependencies
- Depends on WP03 (CLI must be wired up).

### Risks & Mitigations
- ffmpeg timestamp precision may differ from shntool frame-level precision â†’ acceptable for lossy source formats (APE/WV).
- Rare cue sheet encodings (Shift-JIS) not in default fallback â†’ `--encoding` flag covers this.

---

## Dependency & Execution Summary

- **Sequence**: WP01 â†’ WP02 â†’ WP03 â†’ WP04
- **Parallelization**: Within each WP, tests can be written alongside implementation. WP01 and WP02 are strictly sequential (WP02 needs the parser).
- **MVP Scope**: WP01 + WP02 + WP03 deliver the full `cue split` command for FLAC sources. WP04 adds multi-format support and edge case hardening.

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add shntool to nix flake | WP01 | P0 | No |
| T002 | Create cue package __init__ | WP01 | P0 | No |
| T003 | Implement CueParser | WP01 | P0 | No |
| T004 | CueParser unit tests | WP01 | P0 | Yes |
| T005 | Implement splitter core | WP02 | P0 | No |
| T006 | Filename sanitization | WP02 | P0 | No |
| T007 | Metaflac tagging logic | WP02 | P0 | No |
| T008 | Cover art discovery/embedding | WP02 | P0 | No |
| T009 | Skip-existing logic | WP02 | P0 | No |
| T010 | Splitter unit tests | WP02 | P0 | Yes |
| T011 | Create cue command group | WP03 | P1 | No |
| T012 | Implement split subcommand | WP03 | P1 | No |
| T013 | Directory scanning logic | WP03 | P1 | No |
| T014 | Remove-originals cleanup | WP03 | P1 | No |
| T015 | Dry-run preview mode | WP03 | P1 | No |
| T016 | Rich output integration | WP03 | P1 | No |
| T017 | CLI integration tests | WP03 | P1 | Yes |
| T018 | ffmpeg fallback splitting | WP04 | P2 | No |
| T019 | Encoding fallback chain | WP04 | P2 | No |
| T020 | --encoding flag handling | WP04 | P2 | No |
| T021 | Multi-FILE cue sheets | WP04 | P2 | No |
| T022 | Edge case handling | WP04 | P2 | No |
| T023 | Multi-format/edge case tests | WP04 | P2 | Yes |
