# Work Packages: Bandcamp Collection Manager

**Inputs**: Design documents from `kitty-specs/007-bandcamp-collection-manager/`
**Prerequisites**: plan.md (required), spec.md (user stories), research.md, data-model.md

**Tests**: Only include explicit testing work when stakeholders request it.

**Organization**: Fine-grained subtasks (`Txxx`) roll up into work packages (`WPxx`). Each work package must be independently deliverable and testable.

**Prompt Files**: Each work package references a matching prompt file in `kitty-specs/007-bandcamp-collection-manager/tasks/` generated by `/spec-kitty.tasks`.

---

## Work Package WP01: Foundation — Models, Config, Exceptions (Priority: P0)

**Goal**: Establish the SQLAlchemy models for Bandcamp data, extend config.toml with `[bandcamp]` section, add Bandcamp-specific exception classes, and create the credentials file read/write module.
**Independent Test**: Models create tables in SQLite; config loads with new `[bandcamp]` section; credentials file can be written and read back.
**Prompt**: `kitty-specs/007-bandcamp-collection-manager/tasks/WP01-foundation-models-config.md`

### Included Subtasks
- [x] T001 Add BandcampRelease, BandcampTrack, BandcampReleaseFormat, BandcampSyncState models to `music_commander/cache/models.py`
- [x] T002 Extend Config dataclass in `music_commander/config.py` with `[bandcamp]` section (session_cookie, default_format, match_threshold)
- [x] T003 [P] Add BandcampError, BandcampAuthError, BandcampParseError to `music_commander/exceptions.py`
- [x] T004 [P] Create `music_commander/bandcamp/__init__.py` package
- [x] T005 Create `music_commander/bandcamp/credentials.py` (read/write `~/.config/music-commander/bandcamp-credentials.json`)
- [x] T006 Create `music_commander/commands/bandcamp/__init__.py` Click group skeleton with shared constants

### Implementation Notes
- Models follow existing CacheTrack pattern: SQLAlchemy 2.0 Mapped syntax, proper indexes
- Config parsing mirrors existing sections in `_parse_config_dict()`
- Credentials file uses atomic write (tempfile swap) consistent with report writing pattern

### Parallel Opportunities
- T003 and T004 can proceed in parallel with T001/T002

### Dependencies
- None (starting package)

### Risks & Mitigations
- Model schema changes later: keep initial schema minimal, add fields as needed in later WPs

---

## Work Package WP02: Authentication — Cookie Extraction & Validation (Priority: P0)

**Goal**: Implement all three authentication methods: browser cookie extraction via rookiepy, manual config fallback, and mini-browser login with temporary Firefox profile. Validate cookies by fetching fan_id from Bandcamp.
**Independent Test**: Running `bandcamp auth --browser firefox` extracts and stores a valid cookie; `bandcamp auth --login` launches Firefox and extracts cookie from profile; invalid cookies produce clear errors.
**Prompt**: `kitty-specs/007-bandcamp-collection-manager/tasks/WP02-authentication.md`

### Included Subtasks
- [x] T007 Create `music_commander/bandcamp/cookies.py` with browser cookie extraction (rookiepy for Firefox/Chrome)
- [x] T008 Add mini-browser login flow in `cookies.py` (temporary Firefox profile, subprocess launch, DISPLAY check, cookie extraction from profile's cookies.sqlite)
- [x] T009 Create cookie validation function: fetch Bandcamp homepage, extract fan_id from `#HomepageApp` data-blob
- [x] T010 Create `music_commander/commands/bandcamp/auth.py` CLI subcommand with `--browser`, `--login` options
- [x] T011 Wire manual config cookie fallback (read from config.toml `[bandcamp].session_cookie`)

### Implementation Notes
- rookiepy extracts the `identity` cookie from `bandcamp.com` domain
- Mini-browser: check `DISPLAY`/`WAYLAND_DISPLAY` env vars; fail with error if headless
- Validation: GET `https://bandcamp.com` with cookie, parse `#HomepageApp` div `data-blob` JSON for `pageContext.identity.fanId`
- Store result in credentials file via `credentials.py`

### Parallel Opportunities
- T007 and T008 are independent cookie extraction methods

### Dependencies
- Depends on WP01 (credentials.py, config, exceptions)

### Risks & Mitigations
- rookiepy may not support all browser versions: graceful error with suggestion to use manual method
- Mini-browser approach requires Firefox installed: document in error message

---

## Work Package WP03: Bandcamp Client & Parser (Priority: P0)

**Goal**: Implement the HTTP client for Bandcamp's collection API and the HTML/JSON parser for extracting page data, download URLs, and format information.
**Independent Test**: Client can fetch collection pages given a valid cookie and fan_id; parser correctly extracts digital_items and download URLs from redownload pages.
**Prompt**: `kitty-specs/007-bandcamp-collection-manager/tasks/WP03-client-parser.md`

### Included Subtasks
- [x] T012 Create `music_commander/bandcamp/client.py` with collection fetching (`/api/fancollection/1/collection_items` endpoint, pagination)
- [x] T013 [P] Create `music_commander/bandcamp/parser.py` with HTML page data extraction (`#pagedata` div, `data-blob` attribute parsing)
- [x] T014 Add download URL resolution in `client.py`: fetch redownload page → parse digital_items → extract format-specific download URLs
- [x] T015 Add rate limiting awareness: detect HTTP 429 or throttle responses, implement backoff

### Implementation Notes
- Collection API: POST with `{"fan_id": X, "count": 100, "older_than_token": "..."}`, paginate until empty `items`
- Parser uses BeautifulSoup4 to find `#pagedata` div and extract `data-blob` JSON
- Download resolution: GET redownload URL → parse `digital_items[].downloads[encoding].url`
- Fail-fast on unexpected HTML structure with BandcampParseError including raw response snippet (truncated 500 chars)

### Parallel Opportunities
- T012 and T013 can proceed in parallel (client vs parser)

### Dependencies
- Depends on WP01 (exceptions, models for type references)

### Risks & Mitigations
- Bandcamp page structure changes: parser includes response snippet in errors for debugging
- Rate limiting: exponential backoff with max 3 retries

---

## Work Package WP04: Fuzzy Matching Engine (Priority: P1)

**Goal**: Implement the fuzzy matching engine using rapidfuzz for both release-level (artist+album) and track-level (artist+title) matching between local library cache and Bandcamp collection.
**Independent Test**: Given known local tracks and Bandcamp releases with minor metadata variations, matcher produces correct confidence scores and tiers.
**Prompt**: `kitty-specs/007-bandcamp-collection-manager/tasks/WP04-fuzzy-matching.md`

### Included Subtasks
- [x] T016 Create `music_commander/bandcamp/matcher.py` with normalization functions (lowercase, strip punctuation, collapse whitespace, remove common suffixes)
- [x] T017 Implement release-level matching: compare (artist, album) tuples with weighted token_sort_ratio
- [x] T018 Implement track-level matching: compare (artist, title) tuples with weighted token_sort_ratio
- [x] T019 Add confidence tier classification (exact >=95, high >=80, low >=60, no match <60)
- [x] T020 Add batch matching function that processes all local tracks against all Bandcamp releases efficiently

### Implementation Notes
- Normalization: `re.sub(r'\([^)]*(?:edition|remaster|deluxe|bonus)[^)]*\)', '', s, flags=re.IGNORECASE)` for common suffixes
- Weighted scoring: artist 40%, album/title 60% using `rapidfuzz.fuzz.token_sort_ratio`
- Batch matching: iterate local tracks, for each compute scores against all BC releases, keep best match above threshold
- Configurable threshold from `config.bandcamp_match_threshold` (default 60)

### Parallel Opportunities
- T016-T019 are sequential (builds on each other), but WP04 as a whole is parallel with WP02/WP03

### Dependencies
- Depends on WP01 (models for BandcampRelease/CacheTrack types)

### Risks & Mitigations
- Performance with large collections: rapidfuzz C++ backend handles 100k comparisons efficiently; consider pre-filtering by first character of artist name if needed

---

## Work Package WP05: Collection Sync Command (Priority: P1)

**Goal**: Implement the `bandcamp sync` CLI subcommand that fetches the user's Bandcamp collection and stores it in the dedicated SQLite tables with incremental sync support.
**Independent Test**: Running `bandcamp sync` with valid auth populates BandcampRelease/Track/Format tables; running again performs incremental update.
**Prompt**: `kitty-specs/007-bandcamp-collection-manager/tasks/WP05-collection-sync.md`

### Included Subtasks
- [x] T021 Create `music_commander/commands/bandcamp/sync.py` CLI subcommand
- [x] T022 Implement full sync flow: authenticate → paginate collection → store releases, tracks, formats
- [x] T023 Implement incremental sync: check BandcampSyncState.last_token, resume pagination from last position
- [x] T024 Handle discography bundles: expand into individual releases
- [x] T025 Add Rich progress display for sync operation

### Implementation Notes
- Auth: load cookie from credentials file or config, validate, get fan_id
- For each collection item: create/update BandcampRelease, parse track listing into BandcampTrack records, store available formats in BandcampReleaseFormat
- Incremental: store `older_than_token` in BandcampSyncState after each page; on re-run, start from stored token
- Progress: use Rich's `Progress` with task count from API response

### Parallel Opportunities
- None within WP05 (sequential workflow)

### Dependencies
- Depends on WP02 (auth/cookie validation), WP03 (client for collection fetching)

### Risks & Mitigations
- Large collections (5000+): pagination handles this naturally; commit to DB every 100 items to avoid memory pressure

---

## Work Package WP06: Match Command (Priority: P1)

**Goal**: Implement the `bandcamp match` CLI subcommand that displays fuzzy matches between local library and Bandcamp collection, grouped by confidence tier.
**Independent Test**: Running `bandcamp match` after sync shows matched and unmatched items with confidence scores in a Rich table.
**Prompt**: `kitty-specs/007-bandcamp-collection-manager/tasks/WP06-match-command.md`

### Included Subtasks
- [x] T026 Create `music_commander/commands/bandcamp/match.py` CLI subcommand
- [x] T027 Load local cache tracks and Bandcamp releases, run batch matching
- [x] T028 Display results in Rich table grouped by confidence tier (exact, high, low, unmatched)
- [x] T029 Add `--output` option to write match results as JSON for downstream use

### Implementation Notes
- Load all CacheTrack records and BandcampRelease records from DB
- Run batch matching from `matcher.py`
- Group and sort results by confidence tier
- Display using Rich table: local artist/album/title | BC artist/album | confidence | tier

### Parallel Opportunities
- WP06 can run in parallel with WP07 (both depend on WP04+WP05)

### Dependencies
- Depends on WP04 (matcher), WP05 (sync populates BC tables)

### Risks & Mitigations
- Performance with large datasets: consider limiting display to top N matches per tier with `--limit`

---

## Work Package WP07: Download Command (Priority: P2)

**Goal**: Implement the `bandcamp download` CLI subcommand and the file download engine that resolves format-specific download URLs and saves files with progress indication.
**Independent Test**: Running `bandcamp download <query> --format flac` downloads the matching release in FLAC format to the specified output path.
**Prompt**: `kitty-specs/007-bandcamp-collection-manager/tasks/WP07-download-command.md`

### Included Subtasks
- [x] T030 Create `music_commander/bandcamp/downloader.py` with download logic (URL resolution, chunked download, progress)
- [x] T031 Add format selection: resolve available formats from BandcampReleaseFormat, match user request or prompt for choice
- [x] T032 Create `music_commander/commands/bandcamp/download.py` CLI subcommand with `--format`, `--output` options
- [x] T033 Support multi-release download with confirmation prompt and aggregate progress
- [x] T034 Handle interrupted downloads: clean up partial files, restart cleanly on retry

### Implementation Notes
- Download flow: query BC collection → resolve redownload URL → fetch digital_items → get format URL → stream download
- Use `requests.get(url, stream=True)` with chunked iteration and Rich progress bar
- Write to `.tmp` file, rename on completion (atomic)
- Multi-release: search query against BC collection cache, confirm list, download sequentially with per-file progress

### Parallel Opportunities
- T030 and T031 can be developed together; T032-T034 build on them

### Dependencies
- Depends on WP03 (client for download URL resolution), WP05 (sync for collection data)

### Risks & Mitigations
- Download URL expiration: resolve URL immediately before download, not in batch
- Large files: chunked streaming prevents memory issues

---

## Work Package WP08: HTML Report with Local Server (Priority: P2)

**Goal**: Implement the `bandcamp report` subcommand that generates an HTML report page with auto-refreshing download links served via a local HTTP server.
**Independent Test**: Running `bandcamp report --format flac` generates an HTML file and starts a local server; clicking links in the browser triggers fresh download URL resolution.
**Prompt**: `kitty-specs/007-bandcamp-collection-manager/tasks/WP08-html-report.md`

### Included Subtasks
- [x] T035 Create `music_commander/commands/bandcamp/report.py` CLI subcommand with `--format`, `--output`, `--unmatched` options
- [x] T036 Create HTML template (Jinja2) listing releases with artist, album, format, purchase date, match status
- [x] T037 Implement local HTTP server (http.server based) with endpoint to resolve fresh download URLs
- [x] T038 Add JavaScript in HTML template to call local server for link refresh on click
- [x] T039 Add server auto-shutdown on inactivity timeout and clean SIGINT handling
- [x] T040 Add filtering support: `--unmatched` flag, search query for subset

### Implementation Notes
- HTML template via Jinja2 (already a project dependency)
- Local server: `http.server.HTTPServer` on random port, single endpoint `/download/<sale_item_id>/<encoding>` that resolves fresh URL and returns 302 redirect
- JS: `onclick` handler that fetches from local server, follows redirect
- Auto-shutdown: track last request time, shutdown after 30 min inactivity

### Parallel Opportunities
- T036 (HTML template) and T037 (server) can proceed in parallel

### Dependencies
- Depends on WP03 (client for URL resolution), WP05 (sync for collection data), WP06 (match for match status display)

### Risks & Mitigations
- Port conflicts: use random port, display URL to user
- Server security: bind to localhost only (127.0.0.1)

---

## Work Package WP09: Repair Workflow (Priority: P2)

**Goal**: Implement the `bandcamp repair` subcommand that reads a `files check` JSON report, matches broken files against Bandcamp collection, presents a Rich TUI for selection, and downloads confirmed replacements.
**Independent Test**: Given a check report with broken files, running `bandcamp repair --report <path>` shows matches in a scrollable TUI, and confirmed selections download replacement files.
**Prompt**: `kitty-specs/007-bandcamp-collection-manager/tasks/WP09-repair-workflow.md`

### Included Subtasks
- [x] T041 Create `music_commander/commands/bandcamp/repair.py` CLI subcommand with `--report`, `--format`, `--dry-run` options
- [x] T042 Parse CheckReport JSON: filter to `status == "error"` results, extract file paths
- [x] T043 For each broken file: look up metadata in local cache, run fuzzy match against Bandcamp collection
- [x] T044 Build Rich TUI with scrollable list: file path, match confidence, BC release, proposed format; allow select/deselect with keyboard
- [x] T045 Implement dry-run mode: display proposed actions without downloading
- [x] T046 Download confirmed replacements: use downloader from WP07, place alongside originals
- [x] T047 Handle format defaulting: use `--format` if provided, otherwise detect original file format from extension

### Implementation Notes
- CheckReport parsing: `json.loads()` → filter `results` where `status == "error"`
- Metadata lookup: query CacheTrack by file path to get artist/album/title
- TUI: Rich `Live` display with keyboard input (up/down arrows for scroll, space for toggle, enter for confirm)
- Format detection: map file extension to Bandcamp encoding key (`.flac` → `flac`, `.mp3` → `mp3-320`)
- Downloaded files placed in same directory as original with `.bandcamp-replacement` suffix to avoid overwriting before user confirms git-annex integration

### Parallel Opportunities
- T042/T043 (matching logic) can develop alongside T044 (TUI)

### Dependencies
- Depends on WP04 (matcher), WP05 (sync), WP07 (downloader)

### Risks & Mitigations
- TUI complexity: start with simple Rich Live display, iterate on UX
- No match for broken file: clearly display "no match found" and skip

---

## Dependency & Execution Summary

- **Sequence**: WP01 → [WP02, WP03, WP04] → [WP05] → [WP06, WP07] → [WP08, WP09]
- **Parallelization**: WP02/WP03/WP04 can run in parallel after WP01. WP06/WP07 can run in parallel after WP05. WP08/WP09 can run in parallel after WP06/WP07.
- **MVP Scope**: WP01 + WP02 + WP03 + WP04 + WP05 + WP06 (auth, sync, match — core value without download/report/repair)

---

## Subtask Index (Reference)

| Subtask ID | Summary | Work Package | Priority | Parallel? |
|------------|---------|--------------|----------|-----------|
| T001 | Add Bandcamp SQLAlchemy models | WP01 | P0 | No |
| T002 | Extend Config with [bandcamp] section | WP01 | P0 | No |
| T003 | Add Bandcamp exception classes | WP01 | P0 | Yes |
| T004 | Create bandcamp package __init__ | WP01 | P0 | Yes |
| T005 | Create credentials.py module | WP01 | P0 | No |
| T006 | Create bandcamp CLI group skeleton | WP01 | P0 | No |
| T007 | Browser cookie extraction (rookiepy) | WP02 | P0 | No |
| T008 | Mini-browser login flow | WP02 | P0 | No |
| T009 | Cookie validation (fan_id extraction) | WP02 | P0 | No |
| T010 | Auth CLI subcommand | WP02 | P0 | No |
| T011 | Manual config cookie fallback | WP02 | P0 | No |
| T012 | Collection API client | WP03 | P0 | Yes |
| T013 | HTML page data parser | WP03 | P0 | Yes |
| T014 | Download URL resolution | WP03 | P0 | No |
| T015 | Rate limiting / backoff | WP03 | P0 | No |
| T016 | String normalization functions | WP04 | P1 | No |
| T017 | Release-level matching | WP04 | P1 | No |
| T018 | Track-level matching | WP04 | P1 | No |
| T019 | Confidence tier classification | WP04 | P1 | No |
| T020 | Batch matching function | WP04 | P1 | No |
| T021 | Sync CLI subcommand | WP05 | P1 | No |
| T022 | Full sync flow | WP05 | P1 | No |
| T023 | Incremental sync | WP05 | P1 | No |
| T024 | Discography bundle expansion | WP05 | P1 | No |
| T025 | Rich progress for sync | WP05 | P1 | No |
| T026 | Match CLI subcommand | WP06 | P1 | No |
| T027 | Load and run batch matching | WP06 | P1 | No |
| T028 | Rich table output by confidence | WP06 | P1 | No |
| T029 | JSON output option | WP06 | P1 | No |
| T030 | Download engine | WP07 | P2 | No |
| T031 | Format selection logic | WP07 | P2 | No |
| T032 | Download CLI subcommand | WP07 | P2 | No |
| T033 | Multi-release download | WP07 | P2 | No |
| T034 | Interrupted download handling | WP07 | P2 | No |
| T035 | Report CLI subcommand | WP08 | P2 | No |
| T036 | HTML Jinja2 template | WP08 | P2 | Yes |
| T037 | Local HTTP server | WP08 | P2 | Yes |
| T038 | JavaScript link refresh | WP08 | P2 | No |
| T039 | Server auto-shutdown | WP08 | P2 | No |
| T040 | Report filtering | WP08 | P2 | No |
| T041 | Repair CLI subcommand | WP09 | P2 | No |
| T042 | Parse CheckReport JSON | WP09 | P2 | Yes |
| T043 | Match broken files to BC collection | WP09 | P2 | Yes |
| T044 | Rich TUI scrollable selection | WP09 | P2 | No |
| T045 | Dry-run mode | WP09 | P2 | No |
| T046 | Download confirmed replacements | WP09 | P2 | No |
| T047 | Format defaulting logic | WP09 | P2 | No |
